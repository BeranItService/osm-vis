<!DOCTYPE html>
<html>
  <head>
    <title>OSMvis - OSM Tag Wiki-History</title>
    <meta charset="utf-8">
    <script src="../src/components/d3/d3.min.js"></script>
    <script src="../src/components/underscore/underscore-min.js"></script>
    <script src="../src/components/moment/min/moment.min.js"></script>
    <script src="../src/components/jquery/dist/jquery.slim.min.js"></script>
    <script src="../src/components/ion.rangeSlider/js/ion.rangeSlider.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../src/components/ion.rangeSlider/css/ion.rangeSlider.css">
    <link rel="stylesheet" type="text/css" href="../src/ion.rangeSlider-skins/ion.rangeSlider.skinFlatNew.css">
    <style>
      html, body {
        font-family: 'Helvetica Neue', Helvetica, sans-serif;
        padding: 0;
        margin: 0;
      }
      h1 {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 200px;
        height: 100px;
        margin-left: -100px;
        margin-top: -86px;
        text-align: center;
        font-size: 25px;
        color: #ccc;
      }
      h1 em {
        color: #999;
      }
      #svg {
        position: absolute;
        left: 50%;
        top: 50%;
        margin-top: -36px;
      }
      .node circle {
        fill: #4682b4;
        xstroke: #4682b4;
        xstroke-width: 1.5px;
      }
      .node text {
        font-size: 10px;
        pointer-events: none;
      }
      .node-internal circle {
        fill: #fff;
        stroke: #4682b4;
        stroke-width: 1.5px;
      }
      .node-internal text {
        text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff;
      }
      .edge {
        fill: none;
        stroke: #ccc;
        stroke-opacity: 0.4;
        stroke-width: 1.5px;
      }
      #timesliderContainer {
        position: absolute;
        left: 50%;
        bottom: 10px;
      }
    </style>
    <script>
      const diameter = Math.min(window.innerHeight, window.innerWidth) - 50
      const labelWidth = 120
      const animationDuration = 300
      const animationDelay = 100
      const animationEventDelay = 450
      const animationEventHold = 600
      
      $(document).ready(() => {
        d3.json('../data/osm-tags-history-wiki.json', data => {
          // prepare the data
          data = _(data).map(d => {
            d.history = _(d.history).map(h => [moment(h[0]), h[1]])
            return d
          })
          const dates = _(data).chain().map(d => _(d.history).map(ts => ts[0])).flatten().value()
          const datesMin = moment.min(dates)
          const datesMax = moment.max(dates)
          const prepareDataForTree = dat => {
            var dataTreeTmp = _(dat).map(d => {
              d.id = d.key + '======' + d.value
              d.parentId = d.key
              return d
            })
            const keys = _(dat).chain().map(x => x.key).uniq().value()
            dataTreeTmp = dataTreeTmp.concat(_(keys).map(k => ({id: k, parentId: '===root===', key: k})))
            return dataTreeTmp.concat([{id: '===root===', parentId: null}])
          }
          
          // diagram
          const svg = d3.select('#svg')
            .append('svg')
            .attr('width', diameter)
            .attr('height', diameter)
            .style('margin-left', -diameter / 2)
            .style('margin-top', -diameter / 2)
            .append('g')
            .attr('transform', `translate(${diameter/2},${diameter/2})`)
          
          var angle = 0;
          const computeAngle = () => {
            const box = d3.select('#svg').select('svg').node().getBoundingClientRect()
            const centerX = d3.event.x - box.left - box.width / 2
            const centerY = d3.event.y - box.top - box.height / 2
            return (Math.atan (centerY / centerX) + (centerX < 0 ? Math.PI : 0)) / (2 * Math.PI) * 180 
          }
          const rotateStart = () => {
            angle -= computeAngle()
          }
          const rotate = () => {
            const a = computeAngle()
            svg.attr('transform', `translate(${diameter/2},${diameter/2}) rotate(${angle + a})`)
          }
          const rotateEnd = () => {
            angle = angle + computeAngle()
          }
          d3.select('#svg').call(d3.drag().on('start', rotateStart).on('drag', rotate).on('end', rotateEnd))
          
          const stratify = d3.stratify().id(d => d.id).parentId(d => d.parentId)
          const tree = d3.tree()
            .size([360, diameter / 2 - labelWidth])
            .separation((a, b) => (a.parent == b.parent ? 1 : 2) / a.depth)
          const project = (a, radius) => [radius * Math.cos((a - 90) / 180 * Math.PI), radius * Math.sin((a - 90) / 180 * Math.PI)]
          
          var lastRedraw = null
          const redraw = m => {
            const dataTree = prepareDataForTree(_(data).filter(d => _(d.history).some(h => h[0].isSameOrBefore(m)) && _(d.history).every(h => h[0].isAfter(m) || h[1] > 0)))
            const root = tree(stratify(_(dataTree).sortBy(x => x.id)))
            
            // draw edges
            const edge = svg
              .selectAll('.edge')
              .data(_(root.descendants()).filter(d => d.data.key !== undefined && d.data.value !== undefined), d => d.data.id)
            edge
              .enter()
              .append('path')
              .style('opacity', 0)
              .attr('class', 'edge')
              .attr('d', d => 'M' + project(d.x, d.y) + 'C' + project(d.x, (d.y + d.parent.y) / 2) + ' ' + project(d.parent.x, (d.y + d.parent.y) / 2) + ' ' + project(d.parent.x, d.parent.y))
            edge
              .exit()
              .remove()
            d3.timeout(() => {
              svg.selectAll('.edge')
                .style('opacity', 1)
            }, animationDuration + 2 * animationDelay)
            
            // animate edges
            d3.timeout(() => {
              svg.selectAll('.edge')
                .transition()
                .duration(animationDuration)
                .attr('d', d => 'M' + project(d.x, d.y) + 'C' + project(d.x, (d.y + d.parent.y) / 2) + ' ' + project(d.parent.x, (d.y + d.parent.y) / 2) + ' ' + project(d.parent.x, d.parent.y))
            }, animationDelay)
            
            // draw nodes
            const node = svg
              .selectAll('.node')
              .data(_(root.descendants()).filter(d => d.data.key !== undefined), d => d.data.id)
            const nodeG = node
              .enter()
              .append('g')
                .style('opacity', 0)
                .attr('class', d => 'node' + (d.children ? ' node-internal' : ' node-leaf') + (d.data.value !== undefined && _(d.data.history).some(h => (h[0].isAfter(lastRedraw) && h[0].isSameOrBefore(m)) || h[0].isAfter(m) && h[0].isSameOrBefore(lastRedraw)) ? ' event' : ''))
                .attr('transform', d => 'translate(' + project(d.x, d.y) + ')')
            nodeG
              .append('circle')
                .attr('r', 2.5)
            nodeG
              .append('text')
                .text(d => (d.data.value) ? d.data.value : d.data.key)
                .attr('dy', '.31em')
                // .attr('x', d => d.x < 180 === !d.children ? 6 : -6)
                // .style('text-anchor', d => d.x < 180 === !d.children ? 'start' : 'end')
                // .attr('transform', d => 'rotate(' + (d.x < 180 ? d.x - 90 : d.x + 90) + ')')
                .attr('x', d => !d.children ? 6 : -6)
                .style('text-anchor', d => !d.children ? 'start' : 'end')
                .attr('transform', d => 'rotate(' + (d.x - 90) + ')')
            node
              .exit()
              .remove()
            d3.timeout(() => {
              svg.selectAll('.node')
                .style('opacity', 1)
            }, animationDuration + 2 * animationDelay)
            
            // animate nodes
            d3.timeout(() => {
              svg.selectAll('.node')
                .transition()
                .duration(animationDuration)
                  .attr('transform', d => 'translate(' + project(d.x, d.y) + ')')
              svg.selectAll('.node').select('text')
                  .transition()
                  .duration(animationDuration)
                    // .attr('x', d => d.x < 180 === !d.children ? 6 : -6)
                    // .style('text-anchor', d => d.x < 180 === !d.children ? 'start' : 'end')
                    // .attr('transform', d => 'rotate(' + (d.x < 180 ? d.x - 90 : d.x + 90) + ')')
                  .attr('x', d => !d.children ? 6 : -6)
                  .style('text-anchor', d => !d.children ? 'start' : 'end')
                  .attr('transform', d => 'rotate(' + (d.x - 90) + ')')
            }, animationDelay)
            
            // animate nodes which have a modification in their history
            d3.timeout(() => {
              svg.selectAll('.event').select('circle')
                .transition()
                .duration(animationEventHold)
                .attr('r', 5)
              d3.timeout(() => {
              svg.selectAll('.event').select('circle')
                .transition()
                .duration(animationEventHold)
                  .attr('r', 2.5)
              }, 2 * animationEventHold)
            }, animationEventDelay)
            
            // save m to lastRedraw
            lastRedraw = m
          }
          
          // slider
          const slider = $('#timeslider').ionRangeSlider({
            min: datesMin.format('x'),
            max: datesMax.format('x'),
            from: datesMin.format('x') / 3 * 2 + datesMax.format('x') / 3,
            grid: true,
            force_edges: true,
            hide_min_max: true,
            hide_from_to: true,
            grid_num: 6,
            prettify: n => moment(n, 'x').format('LL'),
            keyboard: true,
            keyboard_step: 2,
            onChange: n => redraw(moment(n.from, 'x')),
            onUpdate: n => redraw(moment(n.from, 'x')),
          })
          $('#timeslider').data('ionRangeSlider').reset()
          $('#timesliderContainer').css('marginLeft', -diameter/2)
          $('#timesliderContainer .irs').css('width', diameter)
        })
      })
    </script>
  </head>
  <body>
    <h1>OSMvis<br><em>OSM Tag<br>Wiki-History</em></h1>
    <div id="svg"></div>
    <div id="timesliderContainer">
      <input type="text" id="timeslider">
    </div>
  </body>
</html>
